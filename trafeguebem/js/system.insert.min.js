Page=function(){this.geocoder=new google.maps.Geocoder,this.initialLocation=new google.maps.LatLng(-30.02172,-51.184702),this.infowindow=new google.maps.InfoWindow,this.loadedTaxi=!1,this.loadedStops=!1,this.showingStops=!1,this.showingTaxi=!1,this.showPercursos=!0,this.showStopsLine=!0,this.stops=new Array,this.taxis=new Array,this.lines=new Array,this.linesGeo=new Array,this.linesKeys=new Array,this.selectedStops=new Array,this.selectedTaxis=new Array,this.markerClustererTaxi=null,this.cacheJson=new Array,this.typeSearch=new Array,this.map=null,this.typeSearch.l=!0,this.typeSearch.b=!0,this.typeSearch.t=!1,this.initialize=function(){var a={center:this.initialLocation,mapTypeId:google.maps.MapTypeId.ROADMAP,draggableCursor:"auto",draggingCursor:"move",disableDoubleClickZoom:!0,zoom:ZOOM_DEFAULT,maxZoom:ZOOM_MAX,minZoom:ZOOM_MIN,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN,position:google.maps.ControlPosition.TOP_LEFT}};this.map=new google.maps.Map($("#map").get(0),a);var c=new Boolean;"undefined"==typeof $.getUrlVar("id")&&(navigator.geolocation?(c=!0,navigator.geolocation.getCurrentPosition(function(a){page.initialLocation=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),page.map.setCenter(page.initialLocation)},function(){page.handleNoGeolocation(c)})):(c=!1,page.handleNoGeolocation(c)))},this.handleNoGeolocation=function(a){contentString=1==a?"Erro: Servi&ccedil;o de Geo Location falhou.":"",page.infowindow.setContent(contentString),page.infowindow.setPosition(page.initialLocation),page.infowindow.open(page.map),page.map.setCenter(page.initialLocation)},this.searchMarker={start:null,end:null,type:null,startCircle:null,endCircle:null},this.plotCircle=function(){return circle=new google.maps.Circle({strokeColor:"#1D5987",strokeOpacity:.8,strokeWeight:2,fillColor:"#1D5987",fillOpacity:.35,map:this.map,editable:!0,radius:200})},this.addSearchMarker=function(a){var b=this;null==this.searchMarker.start?(this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):null==this.searchMarker.end?(this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):(this.clearMarker("start"),this.clearMarker("end"),$("#txtEnderecoInicial").attr("value",""),$("#txtEnderecoFinal").attr("value",""),this.searchMarker.startCircle.setMap(null),this.searchMarker.endCircle.setMap(null),this.addSearchMarker(a))},this.changedSearchMarkers=function(a){if(void 0==a&&(a=0),!(a>=1)){var b=this;this.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,b.searchMarker.end.getPosition(),b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.searchMarker.start&&b.geocoder.geocode({latLng:b.searchMarker.start.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoInicial").attr("value",c[0].formatted_address),b.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,b.searchMarker.end.getPosition(),b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,null,null)):b.changedSearchMarkers(a+1)})}},this.changeMarker=function(a,b){"start"==b?(this.clearMarker("start"),this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){this.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers()):"end"==b&&(this.clearMarker("end"),this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){this.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers())},this.clearMarker=function(a){"start"==a&&this.searchMarker.start?(this.searchMarker.start.setMap(null),this.searchMarker.start=null,this.searchMarker.startCircle.setMap(null)):"end"==a&&this.searchMarker.end&&(this.searchMarker.end.setMap(null),this.searchMarker.end=null,this.searchMarker.endCircle.setMap(null))},this.showAddress=function(a){var b=this,c=$("#txtEnderecoInicial").attr("value");c=""!=c?c+", RS, Brasil":"";var d=$("#txtEnderecoFinal").attr("value");d=""!=d?d+", RS, Brasil":"",""==c&&b.clearMarker("start"),""==d&&b.clearMarker("end"),b.geocoder.geocode({address:c},function(c,e){e==google.maps.GeocoderStatus.OK&&b.geocoder.geocode({address:d},function(d,e){if(e==google.maps.GeocoderStatus.OK){var f=c[0].geometry.location,g=d[0].geometry.location;"undefined"==typeof a&&(b.changeMarker(f,"start"),b.changeMarker(g,"end")),b.search(f,b.searchMarker.startCircle.radius,g,b.searchMarker.endCircle.radius)}else{var f=c[0].geometry.location;null==b.searchMarker.start&&b.addSearchMarker(f),"undefined"==typeof a&&b.changeMarker(f,"start"),b.search(f,b.searchMarker.startCircle.radius,null,null)}})})},this.getLine=function(a){var b="/getLinha/"+a;instMap=this,$.ajax({type:"GET",url:b,dataType:"json",success:function(a){instMap.cacheJson[a.key]=a.geom,$(".horario").attr("data-name",a.code+" - "+a.name),instMap.showLine(a.key,!1),instMap.map.setZoom(ZOOM_MIN)}})},this.search=function(a,b,c,d,e){this.isSearching&&this.searchInProgress&&(this.searchInProgress.abort(),this.searchInProgress=null,this.isSearching=!1),this.isSearching=!0,json=new Object,new Array,json.term="undefined"!=typeof e?e:null,json.coord=new Object,json.type=new Object,json.type.l=this.typeSearch.l,json.type.b=this.typeSearch.b,json.type.t=this.typeSearch.t,json.coord.start=null!=a?[a.lat(),a.lng(),b]:null,json.coord.end=null!=c?[c.lat(),c.lng(),d]:null;var g=$.toJSON(json),h=this,i="/busca";this.searchInProgress=$.ajax({type:"GET",url:i,data:{json:g},dataType:"json",cache:!1,success:function(a){if(h.isSearching){if(h.isSearching=!1,"undefined"!=typeof a.bus||"undefined"!=typeof a.lotacao){h.hideLines(),html='<table id="tableLinhas"><tr><td class="codigos"><span>Codigo - Sentido</a></td><td class="linhas"><span>Linha</a></td><td class="horario"><span>Horario</a></td></tr>';for(var b="undefined"==typeof a.bus?0:a.bus.length,c=0;b>c;c++)h.cacheJson[a.bus[c].key]=a.bus[c].geom,html+='<tr class="line" data-linha="'+a.bus[c].key+'">'+'<td class="codigos onibus">'+"<span>"+a.bus[c].code+"</span>"+"</td>"+'<td class="linhas">'+"<span>"+a.bus[c].name+"</span>"+"</td>"+'<td class="horario">'+"<span>Horario</span>"+"</td></tr>";for(var d="undefined"==typeof a.lotacao?0:a.lotacao.length,c=0;d>c;c++)h.cacheJson[a.lotacao[c].key]=a.lotacao[c].geom,html+='<tr class="line" data-linha="'+a.lotacao[c].key+'">'+'<td class="codigos lotacao">'+"<span>"+a.lotacao[c].code+"</span>"+"</td>"+'<td class="linhas">'+"<span>"+a.lotacao[c].name+"</span>"+"</td>"+'<td class="horario">'+"</td>"+"</tr>";html+="</table>",0==b&&0==d&&(html="")}else html="<p>Sua busca n&atilde;o retornou resultados!</p>";if($(".result").html(html),h.clearTaxis(),"undefined"!=typeof a.taxi){for(var c=0;c<a.taxi.length;c++){var e=new page.taxi(h.map,new google.maps.LatLng(a.taxi[c].geom.lat,a.taxi[c].geom.lng),!0,!1,a.taxi[c].adress);e.setKey(a.taxi[c].key),h.taxis.push(e)}h.loadedTaxi=!0,h.showTaxi(!0)}}},error:function(a){console.log(a.message)}})},this.plotLine=function(a){var b={strokeColor:a,strokeOpacity:.7,strokeWeight:5},c=new google.maps.Polyline(b);return c.setMap(this.map),c},this.showLine=function(a){var c=this;if($("[data-linha="+a+"]").hasClass("selected"))return c.hideLines(a),void 0;c.lines[a]=new Array;var d=c.plotLine(a);if(animate=!1)c.lineAnimationStep(d,c.cacheJson[a],0,a)();else for(var e=d.getPath(),f=0;f<c.cacheJson[a].length;f++)e.push(new google.maps.LatLng(c.cacheJson[a][f].lat,c.cacheJson[a][f].lng)),c.lines[a].push(d);c.linesKeys.push({key:a,index:c.lines.length-1}),$("[data-linha="+a+"]").addClass("selected"),$("[data-linha="+a+"]").css("background",COLOR[this.linesKeys.length-1])},this.lineAnimationStep=function(a,b,c,d,e){void 0==e&&(e=0);var f=this;return function(){if(c<b.length){var g=a.getPath();g.push(new google.maps.LatLng(b[c].lat,b[c].lng)),f.lines[d].push(a),setTimeout(f.lineAnimationStep(a,b,c+1,d,e),e)}}},this.hideLines=function(a){var b=this;if("undefined"==typeof a)for(var c=0;c<b.linesKeys.length;c++){for(var d=0;d<b.lines[b.linesKeys[c].key].length;d++)b.lines[b.linesKeys[c].key][d].setMap(null);$("[data-linha="+b.linesKeys[c].key+"]").removeClass("selected"),$("[data-linha="+b.linesKeys[c].key+"]").removeAttr("style")}else{for(var d=0;d<b.lines[a].length;d++)b.lines[a][d].setMap(null);$("[data-linha="+a+"]").removeClass("selected"),$("[data-linha="+a+"]").removeAttr("style")}},this.hideStopsLines=function(a){if("undefined"!=typeof a)for(var b=0;b<this.selectedStops[a].length;b++)this.selectedStops[a][b].hide();else for(var c=0;c<this.linesKeys.length;c++)for(var b=0;b<this.selectedStops[this.linesKeys[c].key].length;b++)this.selectedStops[this.linesKeys[c].key][b].hide()},this.showStopsLines=function(){for(var a=0;a<this.linesKeys.length;a++)for(var b=0;b<this.selectedStops[this.linesKeys[a].key].length;b++)this.selectedStops[this.linesKeys[a].key][b].show()},this.showHour=function(a,b){var c="/horario/"+a;$.ajax({type:"GET",url:c,dataType:"json",success:function(c){var d="";ts="undefined"==typeof c.util?0:c.util.length,ts>0&&(d+="<h6>Dias Ut&eacute;is</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.util[e].horario+"</li>";ts>0&&(d+="</ul>"),ts="undefined"==typeof c.sabado?0:c.sabado.length,ts=ts,ts>0&&(d+="<h6>S&aacute;bado</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.sabado[e].horario+"</li>";ts>0&&(d+="</ul>"),ts="undefined"==typeof c.domingo?0:c.domingo.length,ts=ts,ts>0&&(d+="<h6>Domingo</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.domingo[e].horario+"</li>";ts>0&&(d+="</ul>"),""==d&&(d="<p>N&atilde;o foi encontrado hor&aacute;rios</p>"),"undefined"==typeof b&&(b=$("[data-linha="+a+"]").find(".codigos>span").html()+" - "+$("[data-linha="+a+"]").find(".linhas>span").html()),$("#hora").html(d).dialog({title:b,width:635,height:300})}})},this.showStopLine=function(){this.showStopsLine=!this.showStopsLine,this.showStopsLine?this.showStopsLines():this.hideStopsLines()},this.isSearching=!1,this.searchInProgress=null,this.showStops=function(){if(this.loadedStops){null==this.MarkerClustererStop&&(this.MarkerClustererStop=new MarkerClusterer(this.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var b=new Array,c=0;c<this.stops.length;c++)b.push(this.stops[c].marker);this.MarkerClustererStop.addMarkers(b),this.showingStops=!0}else{var a=this;setTimeout(function(){a.showStops()},100)}},this.showTaxi=function(){var a=this;if(this.loadedTaxi){null==this.markerClustererTaxi&&(this.markerClustererTaxi=new MarkerClusterer(a.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var b=new Array,c=0;c<this.taxis.length;c++)b.push(this.taxis[c].marker);this.markerClustererTaxi.addMarkers(b),this.showingTaxi=!0}else setTimeout(function(){a.showTaxi()},100)},this.clearTaxis=function(){for(var a=0;a<this.taxis.length;a++)this.taxis[a].hide();this.taxis=new Array,null!=this.markerClustererTaxi&&this.markerClustererTaxi.clearMarkers()},this.clearStops=function(){for(var a=0;a<this.stops.length;a++)this.stops[a].hide();this.stops=new Array},this.clearMap=function(){$("#container_linhas").html(""),this.hideLines(),this.hideStopsLines(),this.clearTaxis(),this.clearStops()},this.stop=function(a,b,c,d,e){void 0==c&&(c=!1),void 0==d&&(d=!1),void 0==e&&(e=""),this.map=a,this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map}),this.city="",this.selected=null,this.key="",this.name=e,this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)},this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)},this.show=function(){this.marker.setMap(this.map)},this.hide=function(){this.marker.setMap(null)},this.remove=function(){},this.select=function(){this.selected=!0,this.marker.setIcon(SELECTED_STOPS_ICON)},this.deselect=function(){this.selected=!1,this.marker.setIcon(STOPS_ICON)},this.setTitle=function(a){this.marker.setTitle(a)},this.getTitle=function(){return this.marker.getTitle()},this.getCity=function(){return this.city},this.getPosition=function(){return this.marker.getPosition()},this.setKey=function(a){this.key=a},this.getKey=function(){return this.key},this.updateInfo=function(){var a=this;a.geocoder.geocode({location:this.marker.getPosition()},function(b,c){if(c==google.maps.GeocoderStatus.OK){for(var d="",e="",f="",g=0;g<b[0].address_components.length;g++)for(var h=b[0].address_components[g].types,i=0;i<h.length;i++)"locality"==h[i]?e=b[0].address_components[g].long_name:"street_number"==h[i]?f=b[0].address_components[g].long_name:"route"==h[i]&&(d=b[0].address_components[g].long_name);var j="Rua ?";""!=d&&(j=d),""!=f&&(j+=", "+f),""!=e&&(j+=" - "+e),a.city=e,a.name=j,a.marker.setTitle(j)}else a.city="",a.name="Parada",a.marker.setTitle("Parada")})},""==e?this.updateInfo():this.setTitle(this.name),d?this.select():this.deselect()},this.taxi=function(a,b,c,d,e){void 0==c&&(c=!1),void 0==d&&(d=!1),void 0==e&&(e=""),this.map=a,this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map}),this.city="",this.selected=null,this.key="",this.name=e,this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)},this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)},this.show=function(){this.marker.setMap(this.map)},this.hide=function(){this.marker.setMap(null)},this.remove=function(){},this.select=function(){this.selected=!0,this.marker.setIcon(TAXI_ICON)},this.deselect=function(){this.selected=!1,this.marker.setIcon(TAXI_ICON)},this.setTitle=function(a){this.marker.setTitle(a)},this.getTitle=function(){return this.marker.getTitle()},this.getCity=function(){return this.city},this.getPosition=function(){return this.marker.getPosition()},this.setKey=function(a){this.key=a},this.getKey=function(){return this.key},this.updateInfo=function(){instMap.geocoder.geocode({location:this.marker.getPosition()},function(a,b){if(b==google.maps.GeocoderStatus.OK){for(var c="",d="",e="",f=0;f<a[0].address_components.length;f++)for(var g=a[0].address_components[f].types,h=0;h<g.length;h++)"locality"==g[h]?d=a[0].address_components[f].long_name:"street_number"==g[h]?e=a[0].address_components[f].long_name:"route"==g[h]&&(c=a[0].address_components[f].long_name);var i="Rua ?";""!=c&&(i=c),""!=e&&(i+=", "+e),""!=d&&(i+=" - "+d),instMap.city=d,instMap.name=i,instMap.marker.setTitle(i)}else instMap.city="",instMap.name="Ponto de Taxi",instMap.marker.setTitle("Ponto de Taxi")})},""==e?this.updateInfo():this.setTitle(this.name),d?this.select():this.deselect()},this.addLinkerListeners=function(){if(this.loadedStops)for(var instance=this,i=0;i<this.stops.length;i++)with({idx:i})this.stops[i].addListener("click",function(){instance.addLineStop(idx)});else{var instance=this;setTimeout(function(){instance.addLinkerListeners()},100)}},this.submitLinkedStops=function(){var a=$("#line").get(0),b=new Object;if(b.lineStops=new Array,obj=new Object,obj.line=a.options[a.selectedIndex].value,"__None__"!=obj.line){obj.stops=new Array;for(var c=0;c<this.selectedStops.length;c++)obj.stops.push(this.selectedStops[c].getKey());b.lineStops.push(obj);var d=$.toJSON(b);$.ajax({url:"/insert",type:"POST",data:{json:d},dataType:"html",success:function(){alert("Paradas submetidas com sucesso!")}})}},this.updateLineStopsList=function(){for(var a="",b=0;b<this.selectedStops.length;b++)a+='<option value="'+b+'">'+this.selectedStops[b].name+"</option>\n",this.selectedStops[b].setTitle("#"+(b+1)+" - "+this.stops[this.selectedStops[b].stopIdx].name),this.selectedStops[b].show();$("#lineStops").html(a)},this.move=function(a){var b=document.getElementById("lineStops"),c=b.selectedIndex,d=1;"up"==a&&(d=-1);var e=(c+this.selectedStops.length+d)%this.selectedStops.length,f=this.selectedStops[c];this.selectedStops[c]=this.selectedStops[e],this.selectedStops[e]=f,this.updateLineStopsList(),b.selectedIndex=e},this.addLineStop=function(i){this.selectedStops.push(this.stops[i]),this.selectedStops[this.selectedStops.length-1].stopIdx=i,this.stops[i].select(),this.updateLineStopsList(),this.stops[i].clearListeners();var instance=this;with({idx:i})this.stops[i].addListener("click",function(){instance.removeLineStop(idx)})},this.removeLineStop=function(i){for(var idx=0;idx<this.selectedStops.length;idx++)this.selectedStops[idx].getPosition()==this.stops[i].getPosition()&&this.selectedStops.splice(idx,1);this.stops[i].deselect(),this.stops[i].setTitle(this.stops[i].name),this.updateLineStopsList(),this.stops[i].clearListeners();var instance=this;with({idx:i})this.stops[i].addListener("click",function(){instance.addLineStop(idx)})},this.insertedPolyline=null,this.insertedNodes=new Array,this.isInserting=!1,this.mapClickListener=null,this.editNodeWindow=new google.maps.InfoWindow,this.insertionMode="line",this.insertTaxi=function(a){var b=new page.taxi(this.map,a,!0,!0);this.selectedTaxis.push(b);var c=this;b.addListener("click",function(){b.hide();var a=c.selectedTaxis.length;c.selectedTaxis.splice(a,1)}),b.addListener("dragend",function(){b.updateInfo()})},this.insertStop=function(a){var b=new page.stop(this.map,a,!0,!0);this.selectedStops.push(b);var c=this;b.addListener("click",function(){b.hide();var a=c.selectedStops.length;c.selectedStops.splice(a,1)}),b.addListener("dragend",function(){b.updateInfo()})},this.insertNode=function(a){this.insertedPolyline||(this.insertedPolyline=this.plotLine("#004276"));var b=this.insertedPolyline.getPath();b.push(a);var c=new google.maps.Marker({position:a,title:"#"+b.getLength(),draggable:!0,map:this.map});this.insertedNodes.push(c);var d=this,e=this.insertedNodes.length-1;google.maps.event.addListener(c,"rightclick",function(){d.showEditNodeWindow(e)}),google.maps.event.addListener(c,"dragend",function(){d.updateInsertedLine()})},this.duplicateNode=function(a){this.editNodeWindow.close();var b=.003,c=new google.maps.Marker({position:new google.maps.LatLng(this.insertedNodes[a].getPosition().lat()+b,this.insertedNodes[a].getPosition().lng()+b),draggable:!0,map:this.map});this.insertedNodes.splice(a,0,c);var d=this;google.maps.event.addListener(c,"dragend",function(){d.updateInsertedLine()}),this.updateInsertedLine()},this.removeNode=function(a){this.editNodeWindow.close(),this.insertedNodes[a].setMap(null),google.maps.event.clearListeners(this.insertedNodes[a],"click"),this.insertedNodes.splice(a,1),this.updateInsertedLine()},this.showEditNodeWindow=function(a){var b="<div style='float:left;width:110px;height:60px'><strong>Op&ccedil;&otilde;es (Nodo #"+(a+1)+")</strong><br/>"+"- <a href='javascript:page.duplicateNode("+a+");'>Duplicar Nodo</a><br/>"+"- <a href='javascript:page.removeNode("+a+");'>Remover Nodo</a>"+"</div>";this.editNodeWindow.setContent(b),this.editNodeWindow.open(this.map,this.insertedNodes[a])},this.updateInsertedLine=function(){this.insertedPolyline.setMap(null),this.insertedPolyline=this.plotLine("#004276");for(var path=this.insertedPolyline.getPath(),instance=this,i=0;i<this.insertedNodes.length;i++){this.insertedNodes[i].setTitle("#"+(i+1));var pos=this.insertedNodes[i].getPosition();with(path.push(pos),google.maps.event.clearListeners(this.insertedNodes[i],"click"),{idx:i})google.maps.event.addListener(this.insertedNodes[i],"rightclick",function(){instance.showEditNodeWindow(idx)})}},this.editLine=function(a){var b="/getLinha/"+a;instMap=this,$.ajax({type:"GET",url:b,dataType:"json",success:function(a){for(var b=0;b<a.geom.length;b++)page.insertNode(new google.maps.LatLng(a.geom[b].lat,a.geom[b].lng));page.map.setCenter(new google.maps.LatLng(a.geom[0].lat,a.geom[0].lng))}})},this.popNode=function(){this.insertedPolyline.getPath().pop(),marker=this.insertedNodes.pop(),marker.setMap(null)},this.validInsertionModes=["line","stop","taxi","other"],this.setInsertionMode=function(a){for(var b=!1,c=0;c<this.validInsertionModes.length;c++)a==this.validInsertionModes[c]&&(b=!0);if(b){this.insertionMode=a,this.mapClickListener&&google.maps.event.removeListener(this.mapClickListener);var d=this;this.mapClickListener="line"==a?google.maps.event.addListener(this.map,"click",function(a){d.insertNode(a.latLng)}):"stop"==a?google.maps.event.addListener(this.map,"click",function(a){d.insertStop(a.latLng)}):"taxi"==a?google.maps.event.addListener(this.map,"click",function(a){d.insertTaxi(a.latLng)}):null}},this.clearInsertedLine=function(){this.insertedPolyline.setMap(null),this.insertedPolyline=this.plotLine("#004276");for(var a=0;a<this.insertedNodes.length;a++)this.insertedNodes[a].setMap(null);this.insertedNodes=new Array},this.reverseLine=function(){for(var a=new Array,b=0;b<this.insertedNodes.length;b++)a.push(this.insertedNodes[b].getPosition());a=a.reverse(),this.clearInsertedLine();for(var b=0;b<a.length;b++)this.insertNode(a[b])},this.insert=function(){var c=new Object;c.geom=new Array;for(var f=0;f<this.insertedNodes.length;f++){if(f>0&&(distance=google.maps.geometry.spherical.computeDistanceBetween(this.insertedNodes[f-1].getPosition(),this.insertedNodes[f].getPosition()),distance>200))for(n=Math.round(distance/150),oldpos=this.insertedNodes[f-1].getPosition(),curpos=this.insertedNodes[f].getPosition(),lat=Math.abs(oldpos.lat())-Math.abs(curpos.lat()),lng=Math.abs(oldpos.lng())-Math.abs(curpos.lng()),lat/=n,lng/=n,j=1;n>j;j++)a=new google.maps.LatLng(oldpos.lat()+lat*j,oldpos.lng()+lng*j),c.geom.push(new Array(a.lat(),a.lng()));var g=this.insertedNodes[f].getPosition();c.geom.push(new Array(g.lat(),g.lng()))}c.codigointerno=$('[name="txtCodigoInterno"]').val(),c.codigo=$('[name="txtCodigo"]').val(),c.nome=$('[name="txtNome"]').val(),c.tipo=$('[name="selCity"]').val(),c.company=$('[name="selCompany"]').val(),c.city=$('[name="selCity"]').val(),c.way=$('[name="selWay"]').val(),c.tipo=$('[name="selTipo"]').val(),c.modalidade=$('[name="selModalidade"]').val(),c.restrito=$('[name="chkRestrito"]').is(":checked")?"1":"0",c.status=$('[name="chkStatus"]').is(":checked")?"1":"2",c.id=$('[name="hdnId"]').val(),c.clonar=$('[name="hdnClonar"]').val(),this.isInserting=!0;var h=$.toJSON(c);this.waitForInsertion();var i=this,k="insert";instMap=this,$.ajax({type:"POST",url:k,data:{json:h},dataType:"json",success:function(){i.isInserting=!1,location.replace($.getUrl())}})},this.waitForInsertion=function(){if(this.isInserting){var a="Inserindo itens no banco de dados!";this.showWarning("Aguarde",a,!0);var b=this;setTimeout(function(){b.waitForInsertion()},100)}else this.hideWarning()},this.showWarning=function(a,b,c,d){void 0==c&&(c=!0),void 0==d&&(d={Ok:function(){page.hideWarning()}}),$("#popupDialog").dialog({buttons:d,modal:c,title:a,autoOpen:!1}),$("#popupDialog").html(b),$("#popupDialog").dialog("open")},this.hideWarning=function(){$("#popupDialog").dialog("close")}};