Page=function(){this.geocoder=new google.maps.Geocoder;this.initialLocation=new google.maps.LatLng(-30.02172,-51.184702);this.infowindow=new google.maps.InfoWindow;this.showingTaxi=this.showingStops=this.loadedStops=this.loadedTaxi=!1;this.showStopsLine=this.showPercursos=!0;this.stops=[];this.taxis=[];this.lines=[];this.linesGeo=[];this.linesKeys=[];this.selectedStops=[];this.selectedTaxis=[];this.markerClustererTaxi=null;this.cacheJson=[];this.typeSearch=[];this.map=null;this.typeSearch.l=!0;this.typeSearch.b=
!0;this.typeSearch.t=!1;this.initialize=function(){var a={center:this.initialLocation,mapTypeId:google.maps.MapTypeId.ROADMAP,draggableCursor:"auto",draggingCursor:"move",disableDoubleClickZoom:!0,zoom:ZOOM_DEFAULT,maxZoom:ZOOM_MAX,minZoom:ZOOM_MIN,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN,position:google.maps.ControlPosition.TOP_LEFT}};
this.map=new google.maps.Map($("#map").get(0),a);var b=new Boolean;navigator.geolocation?(b=!0,navigator.geolocation.getCurrentPosition(function(a){page.initialLocation=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);page.map.setCenter(page.initialLocation)},function(){page.handleNoGeolocation(b)})):(b=!1,page.handleNoGeolocation(b))};this.handleNoGeolocation=function(a){contentString=!0==a?"Erro: Servi&ccedil;o de Geo Location falhou.":"";page.infowindow.setContent(contentString);page.infowindow.setPosition(page.initialLocation);
page.infowindow.open(page.map);page.map.setCenter(page.initialLocation)};this.searchMarker={start:null,end:null,type:null,startCircle:null,endCircle:null};this.plotCircle=function(){return circle=new google.maps.Circle({strokeColor:"#1D5987",strokeOpacity:0.8,strokeWeight:2,fillColor:"#1D5987",fillOpacity:0.35,map:this.map,editable:!0,radius:200})};this.addSearchMarker=function(a){var b=this;null==this.searchMarker.start?(this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,
map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):null==this.searchMarker.end?(this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",
draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):(this.clearMarker("start"),this.clearMarker("end"),$("#txtEnderecoInicial").attr("value",""),
$("#txtEnderecoFinal").attr("value",""),this.searchMarker.startCircle.setMap(null),this.searchMarker.endCircle.setMap(null),this.addSearchMarker(a))};this.changedSearchMarkers=function(a){void 0==a&&(a=0);if(!(1<=a)){var b=this;this.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,b.searchMarker.end.getPosition(),
b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.searchMarker.start&&b.geocoder.geocode({latLng:b.searchMarker.start.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoInicial").attr("value",c[0].formatted_address),b.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,
b.searchMarker.end.getPosition(),b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,null,null)):b.changedSearchMarkers(a+1)})}};this.changeMarker=function(a,b){"start"==b?(this.clearMarker("start"),this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){this.changedSearchMarkers()}),
this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers()):"end"==b&&(this.clearMarker("end"),this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){this.changedSearchMarkers()}),
this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers())};this.clearMarker=function(a){"start"==a&&this.searchMarker.start?(this.searchMarker.start.setMap(null),this.searchMarker.start=null,this.searchMarker.startCircle.setMap(null)):"end"==a&&this.searchMarker.end&&(this.searchMarker.end.setMap(null),
this.searchMarker.end=null,this.searchMarker.endCircle.setMap(null))};this.showAddress=function(a){var b=this,c=$("#txtEnderecoInicial").attr("value"),c=""!=c?c+", RS, Brasil":"",d=$("#txtEnderecoFinal").attr("value"),d=""!=d?d+", RS, Brasil":"";""==c&&b.clearMarker("start");""==d&&b.clearMarker("end");b.geocoder.geocode({address:c},function(c,h){h==google.maps.GeocoderStatus.OK&&b.geocoder.geocode({address:d},function(d,h){if(h==google.maps.GeocoderStatus.OK){var j=c[0].geometry.location,l=d[0].geometry.location;
"undefined"==typeof a&&(b.changeMarker(j,"start"),b.changeMarker(l,"end"));b.search(j,b.searchMarker.startCircle.radius,l,b.searchMarker.endCircle.radius)}else j=c[0].geometry.location,null==b.searchMarker.start&&b.addSearchMarker(j),"undefined"==typeof a&&b.changeMarker(j,"start"),b.search(j,b.searchMarker.startCircle.radius,null,null)})})};this.getLine=function(a){instMap=this;$.ajax({type:"GET",url:"http://trafeguemelhor.com.br/linha/"+a,async:!1,jsonpCallback:"linha",contentType:"application/json",
dataType:"jsonp",cache:!1,success:function(a){instMap.cacheJson[a.key]=a.geom;$(".horario").attr("data-name",a.code+" - "+a.name);instMap.showLine(a.key,!1);instMap.map.setZoom(ZOOM_MIN)}})};this.search=function(a,b,c,d,e){this.isSearching&&this.searchInProgress&&(this.searchInProgress.abort(),this.searchInProgress=null,this.isSearching=!1);this.isSearching=!0;json={};json.term="undefined"!=typeof e?e:null;json.coord={};json.type={};json.type.l=this.typeSearch.l;json.type.b=this.typeSearch.b;json.type.t=
this.typeSearch.t;json.coord.start=null!=a?[a.lat(),a.lng(),b]:null;json.coord.end=null!=c?[c.lat(),c.lng(),d]:null;var a=$.toJSON(json),h=this;this.searchInProgress=$.ajax({type:"GET",url:"http://trafeguemelhor.com.br/busca",async:!1,data:{json:a},jsonpCallback:"busca",contentType:"application/json",dataType:"jsonp",cache:!1,success:function(a){if(h.isSearching){h.isSearching=!1;if("undefined"!=typeof a.bus||"undefined"!=typeof a.lotacao){h.hideLines();html='<table id="tableLinhas"><tr><td class="codigos"><span>Codigo - Sentido</a></td><td class="linhas"><span>Linha</a></td><td class="horario"><span>Horario</a></td></tr>';
for(var b="undefined"==typeof a.bus?0:a.bus.length,c=0;c<b;c++)h.cacheJson[a.bus[c].key]=a.bus[c].geom,html+='<tr class="line" data-linha="'+a.bus[c].key+'"><td class="codigos onibus"><span>'+a.bus[c].code+'</span></td><td class="linhas"><span>'+a.bus[c].name+'</span></td><td class="horario"><span>Horario</span></td></tr>';for(var d="undefined"==typeof a.lotacao?0:a.lotacao.length,c=0;c<d;c++)h.cacheJson[a.lotacao[c].key]=a.lotacao[c].geom,html+='<tr class="line" data-linha="'+a.lotacao[c].key+'"><td class="codigos lotacao"><span>'+
a.lotacao[c].code+'</span></td><td class="linhas"><span>'+a.lotacao[c].name+'</span></td><td class="horario"></td></tr>';html+="</table>";0==b&&0==d&&(html="")}else html="<p>Sua busca n&atilde;o retornou resultados!</p>";$(".result").html(html);h.clearTaxis();if("undefined"!=typeof a.taxi){for(c=0;c<a.taxi.length;c++)b=new page.taxi(h.map,new google.maps.LatLng(a.taxi[c].geom.lat,a.taxi[c].geom.lng),!0,!1,a.taxi[c].adress),b.setKey(a.taxi[c].key),h.taxis.push(b);h.loadedTaxi=!0;h.showTaxi(!0)}}},
error:function(a){console.log(a.message)}})};this.plotLine=function(a){a=new google.maps.Polyline({strokeColor:a,strokeOpacity:0.7,strokeWeight:5});a.setMap(this.map);return a};this.showLine=function(a){if($("[data-linha="+a+"]").hasClass("selected"))this.hideLines(a);else{this.lines[a]=[];var b=this.plotLine(a);animate=!1;for(var c=b.getPath(),d=0;d<this.cacheJson[a].length;d++)c.push(new google.maps.LatLng(this.cacheJson[a][d].lat,this.cacheJson[a][d].lng)),this.lines[a].push(b);this.linesKeys.push({key:a,
index:this.lines.length-1});$("[data-linha="+a+"]").addClass("selected");$("[data-linha="+a+"]").css("background",COLOR[this.linesKeys.length-1])}};this.lineAnimationStep=function(a,b,c,d,e){void 0==e&&(e=0);var h=this;return function(){c<b.length&&(a.getPath().push(new google.maps.LatLng(b[c].lat,b[c].lng)),h.lines[d].push(a),setTimeout(h.lineAnimationStep(a,b,c+1,d,e),e))}};this.hideLines=function(a){if("undefined"==typeof a)for(a=0;a<this.linesKeys.length;a++){for(var b=0;b<this.lines[this.linesKeys[a].key].length;b++)this.lines[this.linesKeys[a].key][b].setMap(null);
$("[data-linha="+this.linesKeys[a].key+"]").removeClass("selected");$("[data-linha="+this.linesKeys[a].key+"]").removeAttr("style")}else{for(b=0;b<this.lines[a].length;b++)this.lines[a][b].setMap(null);$("[data-linha="+a+"]").removeClass("selected");$("[data-linha="+a+"]").removeAttr("style")}};this.hideStopsLines=function(a){if("undefined"!=typeof a)for(var b=0;b<this.selectedStops[a].length;b++)this.selectedStops[a][b].hide();else for(a=0;a<this.linesKeys.length;a++)for(b=0;b<this.selectedStops[this.linesKeys[a].key].length;b++)this.selectedStops[this.linesKeys[a].key][b].hide()};
this.showStopsLines=function(){for(var a=0;a<this.linesKeys.length;a++)for(var b=0;b<this.selectedStops[this.linesKeys[a].key].length;b++)this.selectedStops[this.linesKeys[a].key][b].show()};this.showHour=function(a,b){$.ajax({type:"GET",url:"http://trafeguemelhor.com.br/horario/"+a,async:!1,jsonpCallback:"busca",contentType:"application/json",dataType:"jsonp",cache:!1,success:function(c){var d="";ts="undefined"==typeof c.util?0:c.util.length;0<ts&&(d+="<h6>Dias Ut&eacute;is</h6><ul>");for(var e=
0;e<ts;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.util[e].horario+"</li>";0<ts&&(d+="</ul>");ts="undefined"==typeof c.sabado?0:c.sabado.length;0<ts&&(d+="<h6>S&aacute;bado</h6><ul>");for(e=0;e<ts;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.sabado[e].horario+"</li>";0<ts&&(d+="</ul>");ts="undefined"==typeof c.domingo?0:c.domingo.length;0<ts&&(d+="<h6>Domingo</h6><ul>");for(e=0;e<ts;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.domingo[e].horario+
"</li>";0<ts&&(d+="</ul>");""==d&&(d="<p>N&atilde;o foi encontrado hor&aacute;rios</p>");"undefined"==typeof b&&(b=$("[data-linha="+a+"]").find(".codigos>span").html()+" - "+$("[data-linha="+a+"]").find(".linhas>span").html());$("#hora").html(d).dialog({title:b,width:635,height:300})}})};this.showStopLine=function(){(this.showStopsLine=!this.showStopsLine)?this.showStopsLines():this.hideStopsLines()};this.isSearching=!1;this.searchInProgress=null;this.showStops=function(){if(this.loadedStops){null==
this.MarkerClustererStop&&(this.MarkerClustererStop=new MarkerClusterer(this.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var a=[],b=0;b<this.stops.length;b++)a.push(this.stops[b].marker);this.MarkerClustererStop.addMarkers(a);this.showingStops=!0}else{var c=this;setTimeout(function(){c.showStops()},100)}};this.showTaxi=function(){var a=this;if(this.loadedTaxi){null==this.markerClustererTaxi&&(this.markerClustererTaxi=new MarkerClusterer(a.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));
for(var b=[],c=0;c<this.taxis.length;c++)b.push(this.taxis[c].marker);this.markerClustererTaxi.addMarkers(b);this.showingTaxi=!0}else setTimeout(function(){a.showTaxi()},100)};this.clearTaxis=function(){for(var a=0;a<this.taxis.length;a++)this.taxis[a].hide();this.taxis=[];null!=this.markerClustererTaxi&&this.markerClustererTaxi.clearMarkers()};this.clearStops=function(){for(var a=0;a<this.stops.length;a++)this.stops[a].hide();this.stops=[]};this.clearMap=function(){$("#container_linhas").html("");
this.hideLines();this.hideStopsLines();this.clearTaxis();this.clearStops()};this.stop=function(a,b,c,d,e){void 0==c&&(c=!1);void 0==d&&(d=!1);void 0==e&&(e="");this.map=a;this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map});this.city="";this.selected=null;this.key="";this.name=e;this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)};this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)};this.show=function(){this.marker.setMap(this.map)};
this.hide=function(){this.marker.setMap(null)};this.remove=function(){};this.select=function(){this.selected=!0;this.marker.setIcon(SELECTED_STOPS_ICON)};this.deselect=function(){this.selected=!1;this.marker.setIcon(STOPS_ICON)};this.setTitle=function(a){this.marker.setTitle(a)};this.getTitle=function(){return this.marker.getTitle()};this.getCity=function(){return this.city};this.getPosition=function(){return this.marker.getPosition()};this.setKey=function(a){this.key=a};this.getKey=function(){return this.key};
this.updateInfo=function(){var a=this;a.geocoder.geocode({location:this.marker.getPosition()},function(b,c){if(c==google.maps.GeocoderStatus.OK){for(var d="",e="",g="",f=0;f<b[0].address_components.length;f++)for(var i=b[0].address_components[f].types,k=0;k<i.length;k++)"locality"==i[k]?e=b[0].address_components[f].long_name:"street_number"==i[k]?g=b[0].address_components[f].long_name:"route"==i[k]&&(d=b[0].address_components[f].long_name);f="Rua ?";""!=d&&(f=d);""!=g&&(f+=", "+g);""!=e&&(f+=" - "+
e);a.city=e;a.name=f;a.marker.setTitle(f)}else a.city="",a.name="Parada",a.marker.setTitle("Parada")})};""==e?this.updateInfo():this.setTitle(this.name);d?this.select():this.deselect()};this.taxi=function(a,b,c,d,e){void 0==c&&(c=!1);void 0==d&&(d=!1);void 0==e&&(e="");this.map=a;this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map});this.city="";this.selected=null;this.key="";this.name=e;this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)};this.clearListeners=
function(){google.maps.event.clearInstanceListeners(this.marker)};this.show=function(){this.marker.setMap(this.map)};this.hide=function(){this.marker.setMap(null)};this.remove=function(){};this.select=function(){this.selected=!0;this.marker.setIcon(TAXI_ICON)};this.deselect=function(){this.selected=!1;this.marker.setIcon(TAXI_ICON)};this.setTitle=function(a){this.marker.setTitle(a)};this.getTitle=function(){return this.marker.getTitle()};this.getCity=function(){return this.city};this.getPosition=
function(){return this.marker.getPosition()};this.setKey=function(a){this.key=a};this.getKey=function(){return this.key};this.updateInfo=function(){instMap.geocoder.geocode({location:this.marker.getPosition()},function(a,b){if(b==google.maps.GeocoderStatus.OK){for(var c="",d="",e="",g=0;g<a[0].address_components.length;g++)for(var f=a[0].address_components[g].types,i=0;i<f.length;i++)"locality"==f[i]?d=a[0].address_components[g].long_name:"street_number"==f[i]?e=a[0].address_components[g].long_name:
"route"==f[i]&&(c=a[0].address_components[g].long_name);g="Rua ?";""!=c&&(g=c);""!=e&&(g+=", "+e);""!=d&&(g+=" - "+d);instMap.city=d;instMap.name=g;instMap.marker.setTitle(g)}else instMap.city="",instMap.name="Ponto de Taxi",instMap.marker.setTitle("Ponto de Taxi")})};""==e?this.updateInfo():this.setTitle(this.name);d?this.select():this.deselect()};this.addLinkerListeners=function(){if(this.loadedStops)for(var a=this,b=0;b<this.stops.length;b++)with({idx:b})this.stops[b].addListener("click",function(){a.addLineStop(idx)});
else{var a=this;setTimeout(function(){a.addLinkerListeners()},100)}};this.submitLinkedStops=function(){var a=$("#line").get(0),b={lineStops:[]};obj={};obj.line=a.options[a.selectedIndex].value;if("__None__"!=obj.line){obj.stops=[];for(a=0;a<this.selectedStops.length;a++)obj.stops.push(this.selectedStops[a].getKey());b.lineStops.push(obj);b=$.toJSON(b);$.ajax({url:"/insert",type:"POST",data:{json:b},dataType:"html",success:function(){alert("Paradas submetidas com sucesso!")}})}};this.updateLineStopsList=
function(){for(var a="",b=0;b<this.selectedStops.length;b++)a+='<option value="'+b+'">'+this.selectedStops[b].name+"</option>\n",this.selectedStops[b].setTitle("#"+(b+1)+" - "+this.stops[this.selectedStops[b].stopIdx].name),this.selectedStops[b].show();$("#lineStops").html(a)};this.move=function(a){var b=document.getElementById("lineStops"),c=b.selectedIndex,d=1;"up"==a&&(d=-1);a=(c+this.selectedStops.length+d)%this.selectedStops.length;d=this.selectedStops[c];this.selectedStops[c]=this.selectedStops[a];
this.selectedStops[a]=d;this.updateLineStopsList();b.selectedIndex=a};this.addLineStop=function(a){this.selectedStops.push(this.stops[a]);this.selectedStops[this.selectedStops.length-1].stopIdx=a;this.stops[a].select();this.updateLineStopsList();this.stops[a].clearListeners();var b=this;with({idx:a})this.stops[a].addListener("click",function(){b.removeLineStop(idx)})};this.removeLineStop=function(a){for(var b=0;b<this.selectedStops.length;b++)this.selectedStops[b].getPosition()==this.stops[a].getPosition()&&
this.selectedStops.splice(b,1);this.stops[a].deselect();this.stops[a].setTitle(this.stops[a].name);this.updateLineStopsList();this.stops[a].clearListeners();var c=this;with({idx:a})this.stops[a].addListener("click",function(){c.addLineStop(b)})};this.insertedPolyline=null;this.insertedNodes=[];this.isInserting=!1;this.mapClickListener=null;this.editNodeWindow=new google.maps.InfoWindow;this.insertionMode="line";this.insertTaxi=function(a){var b=new page.taxi(this.map,a,!0,!0);this.selectedTaxis.push(b);
var c=this;b.addListener("click",function(){b.hide();c.selectedTaxis.splice(c.selectedTaxis.length,1)});b.addListener("dragend",function(){b.updateInfo()})};this.insertStop=function(a){var b=new page.stop(this.map,a,!0,!0);this.selectedStops.push(b);var c=this;b.addListener("click",function(){b.hide();c.selectedStops.splice(c.selectedStops.length,1)});b.addListener("dragend",function(){b.updateInfo()})};this.insertNode=function(a){this.insertedPolyline||(this.insertedPolyline=this.plotLine("#004276"));
var b=this.insertedPolyline.getPath();b.push(a);a=new google.maps.Marker({position:a,title:"#"+b.getLength(),draggable:!0,map:this.map});this.insertedNodes.push(a);var c=this,d=this.insertedNodes.length-1;google.maps.event.addListener(a,"rightclick",function(){c.showEditNodeWindow(d)});google.maps.event.addListener(a,"dragend",function(){c.updateInsertedLine()})};this.duplicateNode=function(a){this.editNodeWindow.close();var b=new google.maps.Marker({position:new google.maps.LatLng(this.insertedNodes[a].getPosition().lat()+
0.003,this.insertedNodes[a].getPosition().lng()+0.003),draggable:!0,map:this.map});this.insertedNodes.splice(a,0,b);var c=this;google.maps.event.addListener(b,"dragend",function(){c.updateInsertedLine()});this.updateInsertedLine()};this.removeNode=function(a){this.editNodeWindow.close();this.insertedNodes[a].setMap(null);google.maps.event.clearListeners(this.insertedNodes[a],"click");this.insertedNodes.splice(a,1);this.updateInsertedLine()};this.showEditNodeWindow=function(a){var b;b="<strong>Op\u00e7\u00f5es (Nodo #"+
(a+1)+")</strong><br/>"+("- <a href='javascript:page.duplicateNode("+a+");'>Duplicar Nodo</a><br/>");b+="- <a href='javascript:page.removeNode("+a+");'>Remover Nodo</a>";b+="- <a href='#'>Adicionar Horario</a>";this.editNodeWindow.setContent(b);this.editNodeWindow.open(this.map,this.insertedNodes[a])};this.updateInsertedLine=function(){this.insertedPolyline.setMap(null);this.insertedPolyline=this.plotLine("#004276");for(var a=this.insertedPolyline.getPath(),b=this,c=0;c<this.insertedNodes.length;c++){this.insertedNodes[c].setTitle("#"+
(c+1));var d=this.insertedNodes[c].getPosition();a.push(d);google.maps.event.clearListeners(this.insertedNodes[c],"click");with({idx:c})google.maps.event.addListener(this.insertedNodes[c],"click",function(){b.showEditNodeWindow(idx)})}};this.editLine=function(a){instMap=this;$.ajax({type:"GET",url:"http://trafeguemelhor.com.br/linha/"+a,async:!1,jsonpCallback:"linha",contentType:"application/json",dataType:"jsonp",cache:!1,success:function(a){for(var c=0;c<a.geom.length;c++)page.insertNode(new google.maps.LatLng(a.geom[c].lat,
a.geom[c].lng))}})};this.popNode=function(){this.insertedPolyline.getPath().pop();marker=this.insertedNodes.pop();marker.setMap(null)};this.validInsertionModes=["line","stop","taxi","other"];this.setInsertionMode=function(a){for(var b=!1,c=0;c<this.validInsertionModes.length;c++)a==this.validInsertionModes[c]&&(b=!0);if(b){this.insertionMode=a;this.mapClickListener&&google.maps.event.removeListener(this.mapClickListener);var d=this;this.mapClickListener="line"==a?google.maps.event.addListener(this.map,
"click",function(a){d.insertNode(a.latLng)}):"stop"==a?google.maps.event.addListener(this.map,"click",function(a){d.insertStop(a.latLng)}):"taxi"==a?google.maps.event.addListener(this.map,"click",function(a){d.insertTaxi(a.latLng)}):null}};this.clearInsertedLine=function(){this.insertedPolyline.setMap(null);this.insertedPolyline=this.plotLine("#004276");for(var a=0;a<this.insertedNodes.length;a++)this.insertedNodes[a].setMap(null);this.insertedNodes=[]};this.reverseLine=function(){for(var a=[],b=
0;b<this.insertedNodes.length;b++)a.push(this.insertedNodes[b].getPosition());a=a.reverse();this.clearInsertedLine();for(b=0;b<a.length;b++)this.insertNode(a[b])};this.insert=function(){for(var a={geom:[]},b=0;b<this.insertedNodes.length;b++){var c=this.insertedNodes[b].getPosition();a.geom[b]=[];a.geom[b][0]=c.lat();a.geom[b][1]=c.lng()}a.codigo=$('[name="txtCodigo"]').attr("value");a.name=$('[name="txtNome"]').attr("value");a.tipo=$('[name="selTipo"]:checked').attr("value");a.company=$('[name="selCompany"]:checked').attr("value");
a.city=$('[name="selCity"]:checked').attr("value");a.way=$('[name="selWay"]:checked').attr("value");this.isInserting=!0;a=$.toJSON(a);this.waitForInsertion();var d=this;instMap=this;$.ajax({type:"POST",url:a,async:!1,jsonpCallback:"linha",contentType:"application/json",dataType:"jsonp",cache:!1,success:function(){d.isInserting=!1;location.reload(!0)}})};this.waitForInsertion=function(){if(this.isInserting){this.showWarning("Aguarde","Inserindo itens no banco de dados!",!0);var a=this;setTimeout(function(){a.waitForInsertion()},
100)}else this.hideWarning()};this.showWarning=function(a,b,c,d){void 0==c&&(c=!0);void 0==d&&(d={Ok:function(){page.hideWarning()}});$("#popupDialog").dialog({buttons:d,modal:c,title:a,autoOpen:!1});$("#popupDialog").html(b);$("#popupDialog").dialog("open")};this.hideWarning=function(){$("#popupDialog").dialog("close")}};