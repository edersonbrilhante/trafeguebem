Page=function(){this.geocoder=new google.maps.Geocoder;this.initialLocation=new google.maps.LatLng(-30.02172,-51.184702);this.infowindow=new google.maps.InfoWindow;this.showingTaxi=this.showingStops=this.loadedStops=this.loadedTaxi=!1;this.showStopsLine=this.showPercursos=!0;this.stops=[];this.taxis=[];this.lines=[];this.linesGeo=[];this.linesKeys=[];this.selectedStops=[];this.selectedTaxis=[];this.markerClustererTaxi=null;this.cacheJson=[];this.typeSearch=[];this.map=null;this.typeSearch.l=!0;this.typeSearch.b=
!0;this.typeSearch.t=!1;this.initialize=function(){var b={center:this.initialLocation,mapTypeId:google.maps.MapTypeId.ROADMAP,draggableCursor:"auto",draggingCursor:"move",disableDoubleClickZoom:!0,zoom:ZOOM_DEFAULT,maxZoom:ZOOM_MAX,minZoom:ZOOM_MIN,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN,position:google.maps.ControlPosition.TOP_LEFT}};
this.map=new google.maps.Map($("#map").get(0),b);var a=new Boolean;navigator.geolocation?(a=!0,navigator.geolocation.getCurrentPosition(function(a){page.initialLocation=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);page.map.setCenter(page.initialLocation)},function(){page.handleNoGeolocation(a)})):(a=!1,page.handleNoGeolocation(a))};this.handleNoGeolocation=function(b){contentString=!0==b?"Erro: Servi&ccedil;o de Geo Location falhou.":"";page.infowindow.setContent(contentString);page.infowindow.setPosition(page.initialLocation);
page.infowindow.open(page.map);page.map.setCenter(page.initialLocation)};this.searchMarker={start:null,end:null,type:null,startCircle:null,endCircle:null};this.plotCircle=function(){return circle=new google.maps.Circle({strokeColor:"#1D5987",strokeOpacity:0.8,strokeWeight:2,fillColor:"#1D5987",fillOpacity:0.35,map:this.map,editable:!0,radius:200})};this.addSearchMarker=function(b){var a=this;null==this.searchMarker.start?(this.searchMarker.start=new google.maps.Marker({position:b,title:"Origem",draggable:!0,
map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){a.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){a.changedSearchMarkers()}),this.changedSearchMarkers()):null==this.searchMarker.end?(this.searchMarker.end=new google.maps.Marker({position:b,title:"Destino",
draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){a.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){a.changedSearchMarkers()}),this.changedSearchMarkers()):(this.clearMarker("start"),this.clearMarker("end"),$("#txtEnderecoInicial").attr("value",""),
$("#txtEnderecoFinal").attr("value",""),this.searchMarker.startCircle.setMap(null),this.searchMarker.endCircle.setMap(null),this.addSearchMarker(b))};this.changedSearchMarkers=function(b){void 0==b&&(b=0);if(!(1<=b)){var a=this;this.searchMarker.end?a.geocoder.geocode({latLng:a.searchMarker.end.getPosition()},function(d,c){c==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",d[0].formatted_address),a.search(a.searchMarker.start.getPosition(),a.searchMarker.startCircle.radius,a.searchMarker.end.getPosition(),
a.searchMarker.endCircle.radius)):a.changedSearchMarkers(b+1)}):a.searchMarker.start&&a.geocoder.geocode({latLng:a.searchMarker.start.getPosition()},function(d,c){c==google.maps.GeocoderStatus.OK?($("#txtEnderecoInicial").attr("value",d[0].formatted_address),a.searchMarker.end?a.geocoder.geocode({latLng:a.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),a.search(a.searchMarker.start.getPosition(),a.searchMarker.startCircle.radius,
a.searchMarker.end.getPosition(),a.searchMarker.endCircle.radius)):a.changedSearchMarkers(b+1)}):a.search(a.searchMarker.start.getPosition(),a.searchMarker.startCircle.radius,null,null)):a.changedSearchMarkers(b+1)})}};this.changeMarker=function(b,a){"start"==a?(this.clearMarker("start"),this.searchMarker.start=new google.maps.Marker({position:b,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){this.changedSearchMarkers()}),
this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers()):"end"==a&&(this.clearMarker("end"),this.searchMarker.end=new google.maps.Marker({position:b,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){this.changedSearchMarkers()}),
this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers())};this.clearMarker=function(b){"start"==b&&this.searchMarker.start?(this.searchMarker.start.setMap(null),this.searchMarker.start=null,this.searchMarker.startCircle.setMap(null)):"end"==b&&this.searchMarker.end&&(this.searchMarker.end.setMap(null),
this.searchMarker.end=null,this.searchMarker.endCircle.setMap(null))};this.showAddress=function(b){var a=this,d=$("#txtEnderecoInicial").attr("value"),d=""!=d?d+", RS, Brasil":"",c=$("#txtEnderecoFinal").attr("value"),c=""!=c?c+", RS, Brasil":"";""==d&&a.clearMarker("start");""==c&&a.clearMarker("end");a.geocoder.geocode({address:d},function(d,h){h==google.maps.GeocoderStatus.OK&&a.geocoder.geocode({address:c},function(c,h){if(h==google.maps.GeocoderStatus.OK){var j=d[0].geometry.location,l=c[0].geometry.location;
"undefined"==typeof b&&(a.changeMarker(j,"start"),a.changeMarker(l,"end"));a.search(j,a.searchMarker.startCircle.radius,l,a.searchMarker.endCircle.radius)}else j=d[0].geometry.location,null==a.searchMarker.start&&a.addSearchMarker(j),"undefined"==typeof b&&a.changeMarker(j,"start"),a.search(j,a.searchMarker.startCircle.radius,null,null)})})};this.getLine=function(b){b=HOST+"/linha/"+b;instMap=this;$.ajax({type:"GET",url:b,async:!1,jsonpCallback:"linha",contentType:"application/json",dataType:"jsonp",
cache:!1,success:function(a){instMap.cacheJson[a.key]=a.geom;$(".horario").attr("data-name",a.code+" - "+a.name);instMap.showLine(a.key,!1);instMap.map.setZoom(ZOOM_MIN)}})};this.search=function(b,a,d,c,e){this.isSearching&&this.searchInProgress&&(this.searchInProgress.abort(),this.searchInProgress=null,this.isSearching=!1);this.isSearching=!0;json={};json.term="undefined"!=typeof e?e:null;json.coord={};json.type={};json.type.l=this.typeSearch.l;json.type.b=this.typeSearch.b;json.type.t=this.typeSearch.t;
json.coord.start=null!=b?[b.lat(),b.lng(),a]:null;json.coord.end=null!=d?[d.lat(),d.lng(),c]:null;var b=$.toJSON(json),h=this;this.searchInProgress=$.ajax({type:"GET",url:HOST+"/busca",async:!1,data:{json:b},jsonpCallback:"busca",contentType:"application/json",dataType:"jsonp",cache:!1,success:function(a){if(h.isSearching){h.isSearching=!1;if("undefined"!=typeof a.bus||"undefined"!=typeof a.lotacao){h.hideLines();html='<table id="tableLinhas"><tr><td class="codigos"><span>Codigo - Sentido</a></td><td class="linhas"><span>Linha</a></td><td class="horario"><span>Horario</a></td></tr>';
for(var b="undefined"==typeof a.bus?0:a.bus.length,c=0;c<b;c++)h.cacheJson[a.bus[c].key]=a.bus[c].geom,html+='<tr class="line" data-linha="'+a.bus[c].key+'"><td class="codigos onibus"><span>'+a.bus[c].code+'</span></td><td class="linhas"><span>'+a.bus[c].name+'</span></td><td class="horario"><span>Horario</span></td></tr>';for(var d="undefined"==typeof a.lotacao?0:a.lotacao.length,c=0;c<d;c++)h.cacheJson[a.lotacao[c].key]=a.lotacao[c].geom,html+='<tr class="line" data-linha="'+a.lotacao[c].key+'"><td class="codigos lotacao"><span>'+
a.lotacao[c].code+'</span></td><td class="linhas"><span>'+a.lotacao[c].name+'</span></td><td class="horario"></td></tr>';html+="</table>";0==b&&0==d&&(html="")}else html="<p>Sua busca n&atilde;o retornou resultados!</p>";$(".result").html(html);h.clearTaxis();if("undefined"!=typeof a.taxi){for(c=0;c<a.taxi.length;c++)b=new page.taxi(h.map,new google.maps.LatLng(a.taxi[c].geom.lat,a.taxi[c].geom.lng),!0,!1,a.taxi[c].adress),b.setKey(a.taxi[c].key),h.taxis.push(b);h.loadedTaxi=!0;h.showTaxi(!0)}}},
error:function(a){console.log(a.message)}})};this.plotLine=function(){var b=new google.maps.Polyline({strokeColor:COLOR[this.linesKeys.length],strokeOpacity:0.7,strokeWeight:5});b.setMap(this.map);return b};this.showLine=function(b){if($("[data-linha="+b+"]").hasClass("selected"))this.hideLines(b);else{this.lines[b]=[];var a=this.plotLine(b);animate=!1;for(var d=a.getPath(),c=0;c<this.cacheJson[b].length;c++)d.push(new google.maps.LatLng(this.cacheJson[b][c].lat,this.cacheJson[b][c].lng)),this.lines[b].push(a);
this.linesKeys.push({key:b,index:this.lines.length-1});$("[data-linha="+b+"]").addClass("selected");$("[data-linha="+b+"]").css("background",COLOR[this.linesKeys.length-1])}};this.lineAnimationStep=function(b,a,d,c,e){void 0==e&&(e=0);var h=this;return function(){d<a.length&&(b.getPath().push(new google.maps.LatLng(a[d].lat,a[d].lng)),h.lines[c].push(b),setTimeout(h.lineAnimationStep(b,a,d+1,c,e),e))}};this.hideLines=function(b){if("undefined"==typeof b)for(b=0;b<this.linesKeys.length;b++){for(var a=
0;a<this.lines[this.linesKeys[b].key].length;a++)this.lines[this.linesKeys[b].key][a].setMap(null);$("[data-linha="+this.linesKeys[b].key+"]").removeClass("selected");$("[data-linha="+this.linesKeys[b].key+"]").removeAttr("style")}else{for(a=0;a<this.lines[b].length;a++)this.lines[b][a].setMap(null);$("[data-linha="+b+"]").removeClass("selected");$("[data-linha="+b+"]").removeAttr("style")}};this.hideStopsLines=function(b){if("undefined"!=typeof b)for(var a=0;a<this.selectedStops[b].length;a++)this.selectedStops[b][a].hide();
else for(b=0;b<this.linesKeys.length;b++)for(a=0;a<this.selectedStops[this.linesKeys[b].key].length;a++)this.selectedStops[this.linesKeys[b].key][a].hide()};this.showStopsLines=function(){for(var b=0;b<this.linesKeys.length;b++)for(var a=0;a<this.selectedStops[this.linesKeys[b].key].length;a++)this.selectedStops[this.linesKeys[b].key][a].show()};this.showHour=function(b,a){$.ajax({type:"GET",url:HOST+"/horario/"+b,async:!1,jsonpCallback:"busca",contentType:"application/json",dataType:"jsonp",cache:!1,
success:function(d){var c="";ts="undefined"==typeof d.util?0:d.util.length;0<ts&&(c+="<h6>Dias Ut&eacute;is</h6><ul>");for(var e=0;e<ts;e++)c+="<li"+("t"==d.util[e].especial?' class="especial"':"")+">"+d.util[e].horario+"</li>";0<ts&&(c+="</ul>");ts="undefined"==typeof d.sabado?0:d.sabado.length;0<ts&&(c+="<h6>S&aacute;bado</h6><ul>");for(e=0;e<ts;e++)c+="<li"+("t"==d.util[e].especial?' class="especial"':"")+">"+d.sabado[e].horario+"</li>";0<ts&&(c+="</ul>");ts="undefined"==typeof d.domingo?0:d.domingo.length;
0<ts&&(c+="<h6>Domingo</h6><ul>");for(e=0;e<ts;e++)c+="<li"+("t"==d.util[e].especial?' class="especial"':"")+">"+d.domingo[e].horario+"</li>";0<ts&&(c+="</ul>");""==c&&(c="<p>N&atilde;o foi encontrado hor&aacute;rios</p>");"undefined"==typeof a&&(a=$("[data-linha="+b+"]").find(".codigos>span").html()+" - "+$("[data-linha="+b+"]").find(".linhas>span").html());$("#hora").html(c).dialog({title:a,width:635,height:300})}})};this.showStopLine=function(){(this.showStopsLine=!this.showStopsLine)?this.showStopsLines():
this.hideStopsLines()};this.isSearching=!1;this.searchInProgress=null;this.showStops=function(){if(this.loadedStops){null==this.MarkerClustererStop&&(this.MarkerClustererStop=new MarkerClusterer(this.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var b=[],a=0;a<this.stops.length;a++)b.push(this.stops[a].marker);this.MarkerClustererStop.addMarkers(b);this.showingStops=!0}else{var d=this;setTimeout(function(){d.showStops()},100)}};this.showTaxi=function(){var b=this;if(this.loadedTaxi){null==
this.markerClustererTaxi&&(this.markerClustererTaxi=new MarkerClusterer(b.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var a=[],d=0;d<this.taxis.length;d++)a.push(this.taxis[d].marker);this.markerClustererTaxi.addMarkers(a);this.showingTaxi=!0}else setTimeout(function(){b.showTaxi()},100)};this.clearTaxis=function(){for(var b=0;b<this.taxis.length;b++)this.taxis[b].hide();this.taxis=[];null!=this.markerClustererTaxi&&this.markerClustererTaxi.clearMarkers()};this.clearStops=function(){for(var b=
0;b<this.stops.length;b++)this.stops[b].hide();this.stops=[]};this.clearMap=function(){$("#container_linhas").html("");this.hideLines();this.hideStopsLines();this.clearTaxis();this.clearStops()};this.stop=function(b,a,d,c,e){void 0==d&&(d=!1);void 0==c&&(c=!1);void 0==e&&(e="");this.map=b;this.marker=new google.maps.Marker({position:a,draggable:d,map:this.map});this.city="";this.selected=null;this.key="";this.name=e;this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)};this.clearListeners=
function(){google.maps.event.clearInstanceListeners(this.marker)};this.show=function(){this.marker.setMap(this.map)};this.hide=function(){this.marker.setMap(null)};this.remove=function(){};this.select=function(){this.selected=!0;this.marker.setIcon(SELECTED_STOPS_ICON)};this.deselect=function(){this.selected=!1;this.marker.setIcon(STOPS_ICON)};this.setTitle=function(a){this.marker.setTitle(a)};this.getTitle=function(){return this.marker.getTitle()};this.getCity=function(){return this.city};this.getPosition=
function(){return this.marker.getPosition()};this.setKey=function(a){this.key=a};this.getKey=function(){return this.key};this.updateInfo=function(){var a=this;a.geocoder.geocode({location:this.marker.getPosition()},function(b,c){if(c==google.maps.GeocoderStatus.OK){for(var d="",e="",g="",f=0;f<b[0].address_components.length;f++)for(var i=b[0].address_components[f].types,k=0;k<i.length;k++)"locality"==i[k]?e=b[0].address_components[f].long_name:"street_number"==i[k]?g=b[0].address_components[f].long_name:
"route"==i[k]&&(d=b[0].address_components[f].long_name);f="Rua ?";""!=d&&(f=d);""!=g&&(f+=", "+g);""!=e&&(f+=" - "+e);a.city=e;a.name=f;a.marker.setTitle(f)}else a.city="",a.name="Parada",a.marker.setTitle("Parada")})};""==e?this.updateInfo():this.setTitle(this.name);c?this.select():this.deselect()};this.taxi=function(b,a,d,c,e){void 0==d&&(d=!1);void 0==c&&(c=!1);void 0==e&&(e="");this.map=b;this.marker=new google.maps.Marker({position:a,draggable:d,map:this.map});this.city="";this.selected=null;
this.key="";this.name=e;this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)};this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)};this.show=function(){this.marker.setMap(this.map)};this.hide=function(){this.marker.setMap(null)};this.remove=function(){};this.select=function(){this.selected=!0;this.marker.setIcon(TAXI_ICON)};this.deselect=function(){this.selected=!1;this.marker.setIcon(TAXI_ICON)};this.setTitle=function(a){this.marker.setTitle(a)};
this.getTitle=function(){return this.marker.getTitle()};this.getCity=function(){return this.city};this.getPosition=function(){return this.marker.getPosition()};this.setKey=function(a){this.key=a};this.getKey=function(){return this.key};this.updateInfo=function(){instMap.geocoder.geocode({location:this.marker.getPosition()},function(a,b){if(b==google.maps.GeocoderStatus.OK){for(var c="",d="",e="",g=0;g<a[0].address_components.length;g++)for(var f=a[0].address_components[g].types,i=0;i<f.length;i++)"locality"==
f[i]?d=a[0].address_components[g].long_name:"street_number"==f[i]?e=a[0].address_components[g].long_name:"route"==f[i]&&(c=a[0].address_components[g].long_name);g="Rua ?";""!=c&&(g=c);""!=e&&(g+=", "+e);""!=d&&(g+=" - "+d);instMap.city=d;instMap.name=g;instMap.marker.setTitle(g)}else instMap.city="",instMap.name="Ponto de Taxi",instMap.marker.setTitle("Ponto de Taxi")})};""==e?this.updateInfo():this.setTitle(this.name);c?this.select():this.deselect()}};