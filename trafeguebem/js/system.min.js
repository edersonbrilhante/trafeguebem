Page=function(){this.geocoder=new google.maps.Geocoder,this.initialLocation=new google.maps.LatLng(-30.02172,-51.184702),this.infowindow=new google.maps.InfoWindow,this.loadedTaxi=!1,this.loadedStops=!1,this.showingStops=!1,this.showingTaxi=!1,this.showPercursos=!0,this.showStopsLine=!0,this.stops=new Array,this.taxis=new Array,this.lines=new Array,this.linesGeo=new Array,this.linesKeys=new Array,this.selectedStops=new Array,this.selectedTaxis=new Array,this.markerClustererTaxi=null,this.cacheJson=new Array,this.typeSearch=new Array,this.map=null,this.typeSearch.l=!0,this.typeSearch.b=!0,this.typeSearch.t=!1,this.initialize=function(){var a={center:this.initialLocation,mapTypeId:google.maps.MapTypeId.ROADMAP,draggableCursor:"auto",draggingCursor:"move",disableDoubleClickZoom:!0,zoom:ZOOM_DEFAULT,maxZoom:ZOOM_MAX,minZoom:ZOOM_MIN,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT},navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.ZOOM_PAN,position:google.maps.ControlPosition.TOP_LEFT}};this.map=new google.maps.Map($("#map").get(0),a);var c=new Boolean;navigator.geolocation?(c=!0,navigator.geolocation.getCurrentPosition(function(a){page.initialLocation=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),page.map.setCenter(page.initialLocation)},function(){page.handleNoGeolocation(c)})):(c=!1,page.handleNoGeolocation(c)),google.maps.event.addListener(this.map,"zoom_changed",function(){console.log("zoom")})},this.handleNoGeolocation=function(a){contentString=1==a?"Erro: Servi&ccedil;o de Geo Location falhou.":"",page.infowindow.setContent(contentString),page.infowindow.setPosition(page.initialLocation),page.infowindow.open(page.map),page.map.setCenter(page.initialLocation)},this.searchMarker={start:null,end:null,type:null,startCircle:null,endCircle:null},this.plotCircle=function(){return circle=new google.maps.Circle({strokeColor:"#1D5987",strokeOpacity:.8,strokeWeight:2,fillColor:"#1D5987",fillOpacity:.35,map:this.map,editable:!0,radius:200})},this.addSearchMarker=function(a){var b=this;null==this.searchMarker.start?(this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):null==this.searchMarker.end?(this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){b.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){b.changedSearchMarkers()}),this.changedSearchMarkers()):(this.clearMarker("start"),this.clearMarker("end"),$("#txtEnderecoInicial").attr("value",""),$("#txtEnderecoFinal").attr("value",""),this.searchMarker.startCircle.setMap(null),this.searchMarker.endCircle.setMap(null),this.addSearchMarker(a))},this.changedSearchMarkers=function(a){if(void 0==a&&(a=0),!(a>=1)){var b=this;this.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,b.searchMarker.end.getPosition(),b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.searchMarker.start&&b.geocoder.geocode({latLng:b.searchMarker.start.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoInicial").attr("value",c[0].formatted_address),b.searchMarker.end?b.geocoder.geocode({latLng:b.searchMarker.end.getPosition()},function(c,d){d==google.maps.GeocoderStatus.OK?($("#txtEnderecoFinal").attr("value",c[0].formatted_address),b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,b.searchMarker.end.getPosition(),b.searchMarker.endCircle.radius)):b.changedSearchMarkers(a+1)}):b.search(b.searchMarker.start.getPosition(),b.searchMarker.startCircle.radius,null,null)):b.changedSearchMarkers(a+1)})}},this.changeMarker=function(a,b){"start"==b?(this.clearMarker("start"),this.searchMarker.start=new google.maps.Marker({position:a,title:"Origem",draggable:!0,map:this.map,icon:MARKER_START}),google.maps.event.addListener(this.searchMarker.start,"dragend",function(){this.changedSearchMarkers()}),this.searchMarker.startCircle=this.plotCircle(),this.searchMarker.startCircle.bindTo("center",this.searchMarker.start,"position"),google.maps.event.addListener(this.searchMarker.startCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers()):"end"==b&&(this.clearMarker("end"),this.searchMarker.end=new google.maps.Marker({position:a,title:"Destino",draggable:!0,map:this.map,icon:MARKER_END}),google.maps.event.addListener(this.searchMarker.end,"dragend",function(){this.changedSearchMarkers()}),this.searchMarker.endCircle=this.plotCircle(),this.searchMarker.endCircle.bindTo("center",this.searchMarker.end,"position"),google.maps.event.addListener(this.searchMarker.endCircle,"radius_changed",function(){this.changedSearchMarkers()}),this.changedSearchMarkers())},this.clearMarker=function(a){"start"==a&&this.searchMarker.start?(this.searchMarker.start.setMap(null),this.searchMarker.start=null,this.searchMarker.startCircle.setMap(null)):"end"==a&&this.searchMarker.end&&(this.searchMarker.end.setMap(null),this.searchMarker.end=null,this.searchMarker.endCircle.setMap(null))},this.showAddress=function(a){var b=this,c=$("#txtEnderecoInicial").attr("value");c=""!=c?c+", RS, Brasil":"";var d=$("#txtEnderecoFinal").attr("value");d=""!=d?d+", RS, Brasil":"",""==c&&b.clearMarker("start"),""==d&&b.clearMarker("end"),b.geocoder.geocode({address:c},function(c,e){e==google.maps.GeocoderStatus.OK&&b.geocoder.geocode({address:d},function(d,e){if(e==google.maps.GeocoderStatus.OK){var f=c[0].geometry.location,g=d[0].geometry.location;"undefined"==typeof a&&(b.changeMarker(f,"start"),b.changeMarker(g,"end")),b.search(f,b.searchMarker.startCircle.radius,g,b.searchMarker.endCircle.radius)}else{var f=c[0].geometry.location;null==b.searchMarker.start&&b.addSearchMarker(f),"undefined"==typeof a&&b.changeMarker(f,"start"),b.search(f,b.searchMarker.startCircle.radius,null,null)}})})},this.getLine=function(a){var b="/getLinha/"+a;instMap=this,$.ajax({type:"GET",url:b,dataType:"json",success:function(a){"undefined"!=typeof a.geom?(instMap.cacheJson[a.key]=a.geom,$(".horario").attr("data-name",a.code+" - "+a.name),instMap.showLine(a.key,!1),instMap.map.setZoom(ZOOM_MIN)):location.href=window.location.href.replace(/linha.*/,"")}})},this.search=function(a,b,c,d,e){this.isSearching&&this.searchInProgress&&(this.searchInProgress.abort(),this.searchInProgress=null,this.isSearching=!1),this.isSearching=!0,json=new Object,new Array,json.term="undefined"!=typeof e?e:null,json.empresa=$("[name=hdnEmpresa]").val(),json.coord=new Object,json.type=new Object,json.type.l=this.typeSearch.l,json.type.b=this.typeSearch.b,json.type.t=this.typeSearch.t,json.coord.start=null!=a?[a.lat(),a.lng(),b]:null,json.coord.end=null!=c?[c.lat(),c.lng(),d]:null;var g=$.toJSON(json),h=this,i="/busca";this.searchInProgress=$.ajax({type:"GET",url:i,data:{json:g},dataType:"json",success:function(a){if(h.isSearching){if(h.isSearching=!1,"undefined"!=typeof a.bus||"undefined"!=typeof a.lotacao){h.hideLines(),html='<table id="tableLinhas"><tr><td class="codigos"><span>Codigo - Sentido</a></td><td class="linhas"><span>Linha</a></td><td class="horario"><span>Horario</a></td></tr>';for(var b="undefined"==typeof a.bus?0:a.bus.length,c=0;b>c;c++)h.cacheJson[a.bus[c].key]=a.bus[c].geom,html+='<tr class="line" data-linha="'+a.bus[c].key+'">'+'<td class="codigos onibus">'+"<span>"+a.bus[c].code+" - "+a.bus[c].way+"</span>"+"</td>"+'<td class="linhas">'+"<span>"+a.bus[c].name+"</span>"+"</td>"+'<td class="horario">'+"<span>Horario</span>"+"</td></tr>";for(var d="undefined"==typeof a.lotacao?0:a.lotacao.length,c=0;d>c;c++)h.cacheJson[a.lotacao[c].key]=a.lotacao[c].geom,html+='<tr class="line" data-linha="'+a.lotacao[c].key+'">'+'<td class="codigos lotacao">'+"<span>"+a.lotacao[c].code+" - "+a.lotacao[c].way+"</span>"+"</td>"+'<td class="linhas">'+"<span>"+a.lotacao[c].name+"</span>"+"</td>"+'<td class="horario">'+"</td>"+"</tr>";html+="</table>",0==b&&0==d&&(html="")}else html="<p>Sua busca n&atilde;o retornou resultados!</p>";if($(".result").html(html),h.clearTaxis(),"undefined"!=typeof a.taxi){for(var c=0;c<a.taxi.length;c++){var e=new page.taxi(h.map,new google.maps.LatLng(a.taxi[c].geom.lat,a.taxi[c].geom.lng),!0,!1,a.taxi[c].adress);e.setKey(a.taxi[c].key),h.taxis.push(e)}h.loadedTaxi=!0,h.showTaxi(!0)}}},error:function(a){console.log(a.message)}})},this.plotLine=function(){var b={strokeColor:COLOR[this.linesKeys.length],strokeOpacity:.7,strokeWeight:5},c=new google.maps.Polyline(b);return c.setMap(this.map),c},this.showLine=function(a){var c=this;if(page.map.setCenter(new google.maps.LatLng(c.cacheJson[a][0].lat,c.cacheJson[a][0].lng)),$("[data-linha="+a+"]").hasClass("selected"))return c.hideLines(a),void 0;c.lines[a]=new Array;var d=c.plotLine(a);if(animate=!1)c.lineAnimationStep(d,c.cacheJson[a],0,a)();else{for(var e=new google.maps.LatLngBounds,f=d.getPath(),g=0;g<c.cacheJson[a].length;g++){var h=new google.maps.LatLng(c.cacheJson[a][g].lat,c.cacheJson[a][g].lng);f.push(h),c.lines[a].push(d),e.extend(h)}page.map.fitBounds(e)}c.linesKeys.push({key:a,index:c.lines.length-1}),$("[data-linha="+a+"]").addClass("selected"),$("[data-linha="+a+"]").css("background",COLOR[this.linesKeys.length-1])},this.lineAnimationStep=function(a,b,c,d,e){void 0==e&&(e=0);var f=this;return function(){if(c<b.length){var g=a.getPath();g.push(new google.maps.LatLng(b[c].lat,b[c].lng)),f.lines[d].push(a),setTimeout(f.lineAnimationStep(a,b,c+1,d,e),e)}}},this.hideLines=function(a){var b=this;if("undefined"==typeof a)for(var c=0;c<b.linesKeys.length;c++){for(var d=0;d<b.lines[b.linesKeys[c].key].length;d++)b.lines[b.linesKeys[c].key][d].setMap(null);$("[data-linha="+b.linesKeys[c].key+"]").removeClass("selected"),$("[data-linha="+b.linesKeys[c].key+"]").removeAttr("style")}else{for(var d=0;d<b.lines[a].length;d++)b.lines[a][d].setMap(null);$("[data-linha="+a+"]").removeClass("selected"),$("[data-linha="+a+"]").removeAttr("style")}},this.hideStopsLines=function(a){if("undefined"!=typeof a)for(var b=0;b<this.selectedStops[a].length;b++)this.selectedStops[a][b].hide();else for(var c=0;c<this.linesKeys.length;c++)for(var b=0;b<this.selectedStops[this.linesKeys[c].key].length;b++)this.selectedStops[this.linesKeys[c].key][b].hide()},this.showStopsLines=function(){for(var a=0;a<this.linesKeys.length;a++)for(var b=0;b<this.selectedStops[this.linesKeys[a].key].length;b++)this.selectedStops[this.linesKeys[a].key][b].show()},this.showHour=function(a,b){var c="/horario/"+a;$.ajax({type:"GET",url:c,dataType:"json",success:function(c){var d="";ts="undefined"==typeof c.util?0:c.util.length,ts>0&&(d+="<h6>Dias Ut&eacute;is</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.util[e].horario+"</li>";ts>0&&(d+="</ul>"),ts="undefined"==typeof c.sabado?0:c.sabado.length,ts=ts,ts>0&&(d+="<h6>S&aacute;bado</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.sabado[e].horario+"</li>";ts>0&&(d+="</ul>"),ts="undefined"==typeof c.domingo?0:c.domingo.length,ts=ts,ts>0&&(d+="<h6>Domingo</h6><ul>");for(var e=0;ts>e;e++)d+="<li"+("t"==c.util[e].especial?' class="especial"':"")+">"+c.domingo[e].horario+"</li>";ts>0&&(d+="</ul>"),""==d&&(d="<p>N&atilde;o foi encontrado hor&aacute;rios</p>"),"undefined"==typeof b&&(b=$("[data-linha="+a+"]").find(".codigos>span").html()+" - "+$("[data-linha="+a+"]").find(".linhas>span").html()),$("#hora").html(d).dialog({title:b,width:635,height:300})}})},this.showStopLine=function(){this.showStopsLine=!this.showStopsLine,this.showStopsLine?this.showStopsLines():this.hideStopsLines()},this.isSearching=!1,this.searchInProgress=null,this.showStops=function(){if(this.loadedStops){null==this.MarkerClustererStop&&(this.MarkerClustererStop=new MarkerClusterer(this.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var b=new Array,c=0;c<this.stops.length;c++)b.push(this.stops[c].marker);this.MarkerClustererStop.addMarkers(b),this.showingStops=!0}else{var a=this;setTimeout(function(){a.showStops()},100)}},this.showTaxi=function(){var a=this;if(this.loadedTaxi){null==this.markerClustererTaxi&&(this.markerClustererTaxi=new MarkerClusterer(a.map,[],{gridSize:40,maxZoom:14,styles:MARKER_CLUSTER_STYLE}));for(var b=new Array,c=0;c<this.taxis.length;c++)b.push(this.taxis[c].marker);this.markerClustererTaxi.addMarkers(b),this.showingTaxi=!0}else setTimeout(function(){a.showTaxi()},100)},this.clearTaxis=function(){for(var a=0;a<this.taxis.length;a++)this.taxis[a].hide();this.taxis=new Array,null!=this.markerClustererTaxi&&this.markerClustererTaxi.clearMarkers()},this.clearStops=function(){for(var a=0;a<this.stops.length;a++)this.stops[a].hide();this.stops=new Array},this.clearMap=function(){$("#container_linhas").html(""),this.hideLines(),this.hideStopsLines(),this.clearTaxis(),this.clearStops()},this.stop=function(a,b,c,d,e){void 0==c&&(c=!1),void 0==d&&(d=!1),void 0==e&&(e=""),this.map=a,this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map}),this.city="",this.selected=null,this.key="",this.name=e,this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)},this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)},this.show=function(){this.marker.setMap(this.map)},this.hide=function(){this.marker.setMap(null)},this.remove=function(){},this.select=function(){this.selected=!0,this.marker.setIcon(SELECTED_STOPS_ICON)},this.deselect=function(){this.selected=!1,this.marker.setIcon(STOPS_ICON)},this.setTitle=function(a){this.marker.setTitle(a)},this.getTitle=function(){return this.marker.getTitle()},this.getCity=function(){return this.city},this.getPosition=function(){return this.marker.getPosition()},this.setKey=function(a){this.key=a},this.getKey=function(){return this.key},this.updateInfo=function(){var a=this;a.geocoder.geocode({location:this.marker.getPosition()},function(b,c){if(c==google.maps.GeocoderStatus.OK){for(var d="",e="",f="",g=0;g<b[0].address_components.length;g++)for(var h=b[0].address_components[g].types,i=0;i<h.length;i++)"locality"==h[i]?e=b[0].address_components[g].long_name:"street_number"==h[i]?f=b[0].address_components[g].long_name:"route"==h[i]&&(d=b[0].address_components[g].long_name);var j="Rua ?";""!=d&&(j=d),""!=f&&(j+=", "+f),""!=e&&(j+=" - "+e),a.city=e,a.name=j,a.marker.setTitle(j)}else a.city="",a.name="Parada",a.marker.setTitle("Parada")})},""==e?this.updateInfo():this.setTitle(this.name),d?this.select():this.deselect()},this.taxi=function(a,b,c,d,e){void 0==c&&(c=!1),void 0==d&&(d=!1),void 0==e&&(e=""),this.map=a,this.marker=new google.maps.Marker({position:b,draggable:c,map:this.map}),this.city="",this.selected=null,this.key="",this.name=e,this.addListener=function(a,b){google.maps.event.addListener(this.marker,a,b)},this.clearListeners=function(){google.maps.event.clearInstanceListeners(this.marker)},this.show=function(){this.marker.setMap(this.map)},this.hide=function(){this.marker.setMap(null)},this.remove=function(){},this.select=function(){this.selected=!0,this.marker.setIcon(TAXI_ICON)},this.deselect=function(){this.selected=!1,this.marker.setIcon(TAXI_ICON)},this.setTitle=function(a){this.marker.setTitle(a)},this.getTitle=function(){return this.marker.getTitle()},this.getCity=function(){return this.city},this.getPosition=function(){return this.marker.getPosition()},this.setKey=function(a){this.key=a},this.getKey=function(){return this.key},this.updateInfo=function(){instMap.geocoder.geocode({location:this.marker.getPosition()},function(a,b){if(b==google.maps.GeocoderStatus.OK){for(var c="",d="",e="",f=0;f<a[0].address_components.length;f++)for(var g=a[0].address_components[f].types,h=0;h<g.length;h++)"locality"==g[h]?d=a[0].address_components[f].long_name:"street_number"==g[h]?e=a[0].address_components[f].long_name:"route"==g[h]&&(c=a[0].address_components[f].long_name);var i="Rua ?";""!=c&&(i=c),""!=e&&(i+=", "+e),""!=d&&(i+=" - "+d),instMap.city=d,instMap.name=i,instMap.marker.setTitle(i)}else instMap.city="",instMap.name="Ponto de Taxi",instMap.marker.setTitle("Ponto de Taxi")})},""==e?this.updateInfo():this.setTitle(this.name),d?this.select():this.deselect()}};